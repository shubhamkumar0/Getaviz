<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Ring</title>
	<meta name="description" content="Getaviz">	
	<script src="aframe-v0.8.2.min.js"></script>
	<script type="text/javascript" src="scripts/camera-beta.js"></script>
	<script src="scripts/vertex-colors-buffer.js"></script>
	<script src="scripts/aframe-geometry-merger-component.min.js"></script>
	
	<script>
		AFRAME.registerComponent('geometry-merger', {
  schema: {
    preserveOriginal: {default: false}
  },

  init: function () {
    var faceIndexEnd;
    var faceIndexStart;
    var self = this;

    this.geometry = new THREE.Geometry();
    this.mesh = new THREE.Mesh(this.geometry);
    this.el.setObject3D('mesh', this.mesh);

    this.faceIndex = {};  // Keep index of original entity UUID to new face array.
    this.vertexIndex = {};  // Keep index of original entity UUID to vertex array.

    this.el.object3D.traverse(function (mesh) {
      if (mesh.type !== 'Mesh') { return; }
      if (mesh === self.mesh) { return; }

      self.faceIndex[mesh.parent.uuid] = [
        self.geometry.faces.length,
        self.geometry.faces.length + mesh.geometry.faces.length - 1
      ];

      self.vertexIndex[mesh.parent.uuid] = [
        self.geometry.vertices.length,
        self.geometry.vertices.length + mesh.geometry.vertices.length - 1
      ];

      // Merge. Use parent's matrix due to A-Frame's <a-entity>(Group-Mesh) hierarchy.
      mesh.parent.updateMatrix();
      self.geometry.merge(mesh.geometry, mesh.parent.matrix);

      // Remove mesh if not preserving.
      if (!self.data.preserveOriginal) { mesh.parent.remove(mesh); }
    });
  }
});
		AFRAME.registerComponent('merged-hover-highlight', {
        dependencies: ['geometry-merger'],

        schema: {
          color: {default: 'orange'}
        },

        init: function () {
          var el = this.el;

          // Work around mouse cursor bugs.
          var firstRun = true;
          var entered = false;

          this.faceIndex = el.components['geometry-merger'].faceIndex;
          this.geometry = el.getObject3D('mesh').geometry;
          this.originalColor = new THREE.Color();

          el.addEventListener('mouseenter', evt => {
            var uuid;

            // Work around mouse cursor bugs.
            if (firstRun) {
              firstRun = false;
              return;
            }

            uuid = evt.detail.target.object3D.uuid;
            this.originalColor.copy(this.geometry.faces[this.faceIndex[uuid][0]].color);
            this.setColor(uuid, this.data.color);
            entered = true;
          });

          el.addEventListener('mouseleave', evt => {
            if (!entered) { return; }
            entered = false;
            this.setColor(evt.detail.target.object3D.uuid, this.originalColor);
          });
        },

        setColor: function (uuid, color) {
          var faceIndex = this.faceIndex;
          var geometry = this.geometry;
          var i;

          for (i = faceIndex[uuid][0]; i <= faceIndex[uuid][1]; i++) {
            geometry.faces[i].color.set(color);
          }
          geometry.colorsNeedUpdate = true;
        }
      });

	</script>
<script>
	AFRAME.registerComponent('buffer-geometry-merger', {
  schema: {
    preserveOriginal: {default: false}
  },

  init: function () {
    var geometries = [];

    this.el.sceneEl.object3D.updateMatrixWorld()
    this.el.object3D.traverse(function (mesh) {
      if (mesh.type !== 'Mesh' || mesh.el === self.el) { return; }
      mesh.geometry.applyMatrix(mesh.matrixWorld);
      geometries.push(mesh.geometry.clone());
      mesh.parent.remove(mesh);
    });

    const geometry = THREE.BufferGeometryUtils.mergeBufferGeometries(geometries);
    this.mesh = new THREE.Mesh(geometry);
    this.el.setObject3D('mesh', this.mesh);
  }
});
</script>
<script>
      AFRAME.registerComponent('face-colors', {
        dependencies: ['geometry'],

        schema: {
          color: {default: '#FFF'}
        },

        init: function () {
          var geometry;
          var i;
          geometry = this.el.getObject3D('mesh').geometry;
          for (i = 0; i < geometry.faces.length; i++) {
            geometry.faces[i].color.set(this.data.color);
          }
          geometry.colorsNeedUpdate = true;
        }
      });
      	</script>
</head>
<body>
<a-scene id="aframe-canvas"  cursor="rayOrigin: mouse" embedded="true" stats>
	<a-entity buffer-geometry-merger material="vertexColors: vertex" merged-hover-highlight>
	<a-entity
			id="camera"
			camera="fov: 80; zoom: 1;"
			position="44.0 20.0 44.0"
			rotation="0 -90 0"
			orbit-camera="
                    target: 15.0 1.5 15.0;
                    enableDamping: true;
                    dampingFactor: 0.25;
                    rotateSpeed: 0.25;
                    panSpeed: 0.25;
                    invertZoom: true;
                    logPosition: false;
                    minDistance:0;
                    maxDistance:1000;
                "
			mouse-cursor=""
	>
	</a-entity>
	
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:32.0;	height:1.0;	depth:40.0"
	 id="ID_bdd240c8fe7174e6ac1cfdd5282de76eb7ad6815"
		   position="19.0 1.5 23.0"
		   vertex-colors-buffer="baseColor: #969696">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:7.0;	height:11.0;	depth:7.0"
	 id="ID_527aa1c76ab5cca95e6dbfcea35a5d2d9f5d737f"
		   position="28.5 7.5 9.5"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:10.0;	height:1.0;	depth:16.0"
	 id="ID_4481fcdc97864a546f67c76536e0308a3058f75d"
		   position="11.0 2.5 32.0"		   
		   vertex-colors-buffer="baseColor: #969696">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:3.0;	height:5.0;	depth:3.0"
	 id="ID_26f25e4da4c82dc2370f3bde0201e612dd88c04c"
		   position="10.5 5.5 35.5"		   
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:4.0;	height:6.0;	depth:4.0"
	 id="ID_9fa088272bab165867bfaddcfbf58d6a7d5d45a2"
		   position="11.0 6.0 29.0"
		   
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:16.0;	height:1.0;	depth:15.0"
	 id="ID_052028080c3d64381f56397d59113102bf4e5921"
		   position="14.0 2.5 13.5"
		   vertex-colors-buffer="baseColor: #969696">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:4.0;	height:6.0;	depth:4.0"
	 id="ID_ecbec7f0190fc1c903a87797d35427dc7a1f240b"
		   position="11.0 6.0 11.0"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:1.0;	height:2.0;	depth:1.0"
	 id="ID_e14c10820a526fde0ea0beee073b947e1ca67a4a"
		   position="18.5 4.0 16.5"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:1.0;	height:2.0;	depth:1.0"
	 id="ID_9e346826c780b8b1975dc8906296cc47974ccd4e"
		   position="14.5 4.0 16.5"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:1.0;	height:2.0;	depth:1.0"
	 id="ID_fba940eea4ca7f9002bc529bbb0cbc8fc0423985"
		   position="16.5 4.0 9.5"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	<a-entity geometry="primitive:box; skipCache: true; buffer:true; width:2.0;	height:4.0;	depth:2.0"
	 id="ID_841936e6f873f49a85e18a4a94df5d7dfe591edf"
		   position="10.0 5.0 17.0"
		   vertex-colors-buffer="baseColor: #353559">
	</a-entity>
	</a-entity>
</a-scene>
</body>
</html>
